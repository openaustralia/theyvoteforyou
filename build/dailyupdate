#!/bin/bash

if [ x$LOCKFILE = x ]
then 
	 /software/bin/run-with-lockfile -n /home/francis/pwdata/dailyupdate-lockfile $0
	if [ $? = 100 ]
	then
		echo "Another copy of dailyupdate is already running" 1>&2
	fi
	exit $?
fi

FROMDATE=2001-06-01
PATH=$PATH:/software/bin
export HOME=/home/francis
export CVS_RSH=/software/bin/ssh

# Grab new scraped XML files from TheyWorkForYou
rsync --recursive www.theyworkforyou.com::pwdata/scrapedxml/divisionsonly /home/francis/pwdata/scrapedxml
chmod -R a+r /home/francis/pwdata

# Update everything
cd ~/publicwhip/
cvs -Q update -dP

# Load new list of members and ministers
cd ~/publicwhip/loader
./memxml2db.pl

# Load new divisions
if ! ./load.pl --quiet --from=$FROMDATE divsxml 
then
	# echo "There were new divisions, recalculating cached values"

	# There were new divisions, so run checks
	./load.pl --quiet --from=$FROMDATE check

	# and update counts of rebels etc.
	./load.pl --quiet --from=$FROMDATE calc

    # clear page cache
    echo "delete from pw_cache_dreaminfo;" | mysql francis
    echo "update pw_dyn_rolliemp set cache_uptodate = 0;" | mysql francis
	rm -fr /home/francis/pwcache/*

	# export dump of database for developers
	cd ~/publicwhip/build
	./export-db
fi

# RSS feeds
RSSDEST=~/www.publicwhip.org.uk_html/feeds
cd ~/publicwhip/loader
./interestingdivisions2rss.pl > $RSSDEST/interestingdivisions.xml
./alldivisions2rss.pl > $RSSDEST/alldivisions.xml



